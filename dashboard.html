<!DOCTYPE html>
<html>
<head>
    <title>NIFTY 50 Alpha Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<h1>NIFTY 50 Alpha Engine</h1>

<select id="stockSelect"></select>

<button onclick="predictStock()">Check Stock</button>

<div id="resultBox"></div>

<script>

const API_URL = "https://nifty50-alpha-engine.onrender.com/rank";
let cachedData = null;

// -----------------------------
// LOAD STOCKS (ONLY ONCE)
// -----------------------------
async function loadStocks(retries = 3) {

    const resultBox = document.getElementById("resultBox");
    resultBox.innerHTML = "<p>Waking up server... please wait.</p>";

    try {
        const response = await fetch(API_URL);

        if (!response.ok) {
            throw new Error("Network response failed");
        }

        const data = await response.json();

        if (data.status !== "success") {
            throw new Error("API returned error");
        }

        cachedData = data;  // âœ… Store data

        const select = document.getElementById("stockSelect");
        select.innerHTML = "";

        data.ranking.forEach(stock => {
            const option = document.createElement("option");
            option.value = stock.ticker;
            option.textContent = stock.ticker.replace(".NS", "");
            select.appendChild(option);
        });

        resultBox.innerHTML = "<p>Select a stock and click 'Check Stock'.</p>";

    } catch (error) {

        console.log("Error loading stocks:", error);

        if (retries > 0) {
            setTimeout(() => loadStocks(retries - 1), 3000);
        } else {
            resultBox.innerHTML =
                "<p>Backend is starting. Please refresh in a few seconds.</p>";
        }
    }
}

// -----------------------------
// PREDICT USING CACHED DATA
// -----------------------------
function predictStock() {

    const select = document.getElementById("stockSelect");
    const resultBox = document.getElementById("resultBox");

    if (!cachedData) {
        resultBox.innerHTML =
            "<p>Data still loading. Please wait a moment.</p>";
        return;
    }

    const ticker = select.value;

    const stock = cachedData.ranking.find(s => s.ticker === ticker);

    if (!stock) {
        resultBox.innerHTML =
            "<p>Stock not found in ranking.</p>";
        return;
    }

    let riskLevel = "Moderate";
    if (stock.percentile >= 70) riskLevel = "Low";
    if (stock.percentile <= 40) riskLevel = "Elevated";

    resultBox.innerHTML = `
        <div class="card">
            <h3>${stock.ticker}</h3>
            <p><strong>Rank:</strong> ${stock.rank} / ${cachedData.total_stocks}</p>
            <p><strong>Percentile Rank:</strong> ${stock.percentile}%</p>
            <p><strong>Risk Level:</strong> ${riskLevel}</p>
            <p style="margin-top:10px; font-size: 0.9em; color: gray;">
                Last Updated: ${cachedData.last_updated}
            </p>
        </div>
    `;
}

// Load when page opens
document.addEventListener("DOMContentLoaded", loadStocks);

</script>

</body>
</html>
