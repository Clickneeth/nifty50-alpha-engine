<script>

const API_URL = "https://nifty50-alpha-engine.onrender.com/rank";

async function loadStocks() {
    try {
        const response = await fetch(API_URL);
        const data = await response.json();

        if (data.status !== "success") return;

        const select = document.getElementById("stockSelect");
        select.innerHTML = "";

        data.ranking.forEach(stock => {
            const option = document.createElement("option");
            option.value = stock.ticker;
            option.textContent = stock.ticker.replace(".NS", "");
            select.appendChild(option);
        });

    } catch (error) {
        console.log("Error loading stocks");
    }
}

async function predictStock() {

    const ticker = document.getElementById("stockSelect").value;

    document.getElementById("resultBox").innerHTML =
        "<p>Loading latest ranking data...</p>";

    try {
        const response = await fetch(API_URL);
        const data = await response.json();

        if (data.status !== "success") {
            document.getElementById("resultBox").innerHTML =
                "<p>Unable to fetch ranking data.</p>";
            return;
        }

        const stock = data.ranking.find(s => s.ticker === ticker);

        if (!stock) {
            document.getElementById("resultBox").innerHTML =
                "<p>Stock not found in ranking.</p>";
            return;
        }

        const probability = stock.percentile;

        let riskLevel = "Moderate";
        if (stock.percentile >= 70) riskLevel = "Low";
        if (stock.percentile <= 40) riskLevel = "Elevated";

        document.getElementById("resultBox").innerHTML = `
            <div class="card">
                <h3>${stock.ticker}</h3>
                <p><strong>Rank:</strong> ${stock.rank} / ${data.total_stocks}</p>
                <p><strong>Percentile Rank:</strong> ${stock.percentile}%</p>
                <p><strong>Probability of Outperformance:</strong> ${probability.toFixed(1)}%</p>
                <p><strong>Risk Level:</strong> ${riskLevel}</p>
                <p style="margin-top:10px; font-size: 0.9em; color: gray;">
                    Last Updated: ${data.last_updated}
                </p>
            </div>
        `;

    } catch (error) {
        document.getElementById("resultBox").innerHTML =
            "<p>Error connecting to backend. Try again in a few seconds.</p>";
    }
}

// Load dropdown automatically when page loads
window.onload = loadStocks;

</script>
